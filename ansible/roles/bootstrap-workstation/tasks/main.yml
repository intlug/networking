---
# Workstation bootstrap tasks - prepares the local system
- name: Check if running as root
  ansible.builtin.fail:
    msg: "This playbook should NOT be run as root. Run as your regular user who is in the libvirt group."
  when: ansible_user_id == 'root'

- name: Ensure user is in libvirt group
  ansible.builtin.command: groups
  register: user_groups
  changed_when: false
  failed_when: "'libvirt' not in user_groups.stdout"

- name: Check if SSH key exists
  ansible.builtin.stat:
    path: "{{ ssh_key_path }}"
  register: ssh_key_stat

- name: Generate SSH key if it doesn't exist
  ansible.builtin.command: ssh-keygen -t rsa -b 4096 -f {{ ssh_key_path }} -N '' -C "ansible@labhost"
  when: not ssh_key_stat.stat.exists
  changed_when: true

- name: Read SSH public key
  ansible.builtin.slurp:
    src: "{{ ssh_pub_key_path }}"
  register: ssh_public_key

- name: Store SSH public key for other roles
  ansible.builtin.set_fact:
    ssh_public_key_content: "{{ ssh_public_key['content'] | b64decode | trim }}"
