- name: Configure sysctl for IP forwarding (but keep disabled)
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '0'
    state: present
    sysctl_file: /etc/sysctl.d/99-ip-forward.conf
    reload: true


# Gather network facts and derive interface names for gateway
- name: Gather network facts
  ansible.builtin.setup:
    gather_subset:
      - network

- name: Display gathered network facts
  ansible.builtin.debug:
    var: ansible_interfaces

- name: Derive gateway interface facts  # noqa: var-naming
  ansible.builtin.set_fact:
    # Build a list of non-loopback interfaces and pick by position
    _nat_ifaces: "{{ (ansible_interfaces | default([]) | reject('equalto', 'lo') | list) }}"
    nat_gateway_public_interface: "{{ (_nat_ifaces[0] if (_nat_ifaces | length) > 0 else '') }}"
    nat_gateway_isolated_interface: "{{ (_nat_ifaces[1] if (_nat_ifaces | length) > 1 else '') }}"

- name: Display derived gateway interface facts
  ansible.builtin.debug:
    msg:
      - "nat_gateway_public_interface={{ nat_gateway_public_interface }}"
      - "nat_gateway_isolated_interface={{ nat_gateway_isolated_interface }}"

- name: Create script to enable NAT for demo
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Enable NAT routing for demo

      echo "Enabling IP forwarding..."
      sudo sysctl -w net.ipv4.ip_forward=1

      echo "Enabling masquerading on public zone..."
      sudo firewall-cmd --zone=public --add-masquerade

      echo "NAT is now enabled!"
      echo "To disable: sudo firewall-cmd --zone=public --remove-masquerade && sudo sysctl -w net.ipv4.ip_forward=0"
    dest: /usr/local/bin/enable-nat.sh
    owner: root
    group: root
    mode: '0755'

- name: Create script to disable NAT
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Disable NAT routing

      echo "Disabling IP forwarding..."
      sudo sysctl -w net.ipv4.ip_forward=0

      echo "Disabling masquerading on public zone..."
      sudo firewall-cmd --zone=public --remove-masquerade

      echo "NAT is now disabled!"
    dest: /usr/local/bin/disable-nat.sh
    owner: root
    group: root
    mode: '0755'

- name: Assign public interface to public zone
  ansible.posix.firewalld:
    zone: public
    interface: "{{ nat_gateway_public_interface }}"
    permanent: true
    state: enabled

- name: Assign isolated interface to internal zone
  ansible.posix.firewalld:
    zone: internal
    interface: "{{ nat_gateway_isolated_interface }}"
    permanent: true
    state: enabled

- name: Add SSH to both zones
  ansible.posix.firewalld:
    zone: "{{ item }}"
    service: ssh
    permanent: true
    state: enabled
  loop:
    - public
    - internal

- name: Configure internal zone to allow forwarding to public
  ansible.posix.firewalld:
    zone: internal
    rich_rule: 'rule family="ipv4" forward-port port="80" protocol="tcp" to-addr="0.0.0.0"'
    permanent: true
    state: enabled

- name: Reload firewalld
  ansible.builtin.systemd:
    name: firewalld
    state: reloaded

- name: Create README for NAT demo
  ansible.builtin.copy:
    content: |
      # NAT Gateway Demo Instructions

      ## Current State
      NAT is DISABLED by default to allow for live demonstration.

      ## To Enable NAT During Demo
      ```bash
      sudo /usr/local/bin/enable-nat.sh
      ```

      Or manually:
      ```bash
      sudo sysctl -w net.ipv4.ip_forward=1
      sudo firewall-cmd --zone=public --add-masquerade
      ```

      ## To Disable NAT
      ```bash
      sudo /usr/local/bin/disable-nat.sh
      ```

      Or manually:
      ```bash
      sudo firewall-cmd --zone=public --remove-masquerade
      sudo sysctl -w net.ipv4.ip_forward=0
      ```

      ## Verify NAT Status
      ```bash
      # Check IP forwarding
      sysctl net.ipv4.ip_forward

      # Check masquerading
      sudo firewall-cmd --zone=public --query-masquerade

      # View routing table
      ip route show
      ```

      ## Test from Internal Hosts
      From labhost2 or labhost3:
      ```bash
      ping -c 4 8.8.8.8
      curl http://google.com
      ```
    dest: /root/NAT-DEMO-README.md
    owner: root
    group: root
    mode: '0644'
