---
# Add isolated interface to a single VM

- name: Get current VM XML configuration
  community.libvirt.virt:
    command: get_xml
    name: "{{ vm_name }}"
  register: libvirt_vm_xml

- name: Check if isolated interface already exists
  ansible.builtin.set_fact:
    libvirt_has_isolated_nic: "{{ 'iso' in libvirt_vm_xml.get_xml }}"

- name: Shutdown VM if running (required to add interface)
  community.libvirt.virt:
    name: "{{ vm_name }}"
    state: shutdown
  when: not libvirt_has_isolated_nic

- name: Wait for VM to shut down
  ansible.builtin.pause:
    seconds: 10
  when: not libvirt_has_isolated_nic

- name: Attach isolated network interface to VM
  ansible.builtin.command:
    cmd: >
      virsh attach-interface {{ vm_name }}
      --type network
      --source iso
      --model virtio
      --config
  when: not libvirt_has_isolated_nic
  register: libvirt_attach_result
  changed_when: libvirt_attach_result.rc == 0

- name: Start VM after adding interface
  community.libvirt.virt:
    name: "{{ vm_name }}"
    state: running
  when: not libvirt_has_isolated_nic

- name: Wait for VM to boot and become accessible via SSH
  ansible.builtin.wait_for:
    host: "{{ vm_name }}.local"
    port: 22
    delay: 5
    timeout: 120
  when: not libvirt_has_isolated_nic

- name: Display interface addition status
  ansible.builtin.debug:
    msg: >
      {% if libvirt_has_isolated_nic %}
      Isolated interface already exists on {{ vm_name }}
      {% else %}
      Successfully added isolated interface to {{ vm_name }}
      {% endif %}
